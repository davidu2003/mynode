# Mynode - VPS统一管理系统需求文档

## 1. 项目概述

Mynode 是一个用于统一管理多台 VPS 服务器的系统，支持通过 Web 控制面板对 VPS 进行批量管理、监控和运维操作。

### 1.1 核心目标
- 统一管理 100+ 台分布在不同厂商的 VPS
- 支持多种操作系统（Ubuntu、Debian、CentOS、Rocky、Alpine 等）
- 通过 Agent 模式实现可靠的双向通信
- 提供简洁易用的 Web 管理界面

### 1.2 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    Control Panel                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │
│  │   React     │  │  Node.js    │  │    SQLite       │  │
│  │ TypeScript  │──│  Fastify    │──│  better-sqlite3 │  │
│  └─────────────┘  └──────┬──────┘  └─────────────────┘  │
└──────────────────────────┼──────────────────────────────┘
                           │ WebSocket
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────▼────┐       ┌────▼────┐       ┌────▼────┐
    │   Go    │       │   Go    │       │   Go    │
    │  Agent  │       │  Agent  │       │  Agent  │
    └─────────┘       └─────────┘       └─────────┘
```

## 2. 功能需求（按当前代码实现更新）

说明：使用 [x] 标识已实现，[ ] 标识未实现或规划中。

### 2.1 账号与安全
- [x] 初始化单管理员账号
- [x] 登录 / 退出 / 登录状态校验
- [x] 修改密码
- [x] 登录失败锁定（5 次 / 15 分钟）
- [x] JWT Cookie 会话
- [ ] 多用户与权限模型

### 2.2 VPS 接入与管理

#### 2.2.1 VPS 基础信息
- [x] 名称（自定义名称）
- [x] Logo（上传 Base64 或 URL）
- [x] 厂商网址
- [x] IP 地址（连接用，支持内网 IP）
- [x] 公网 IP 地址（从被控服务器获取，IPv4/IPv6）
- [x] IP 地理位置（国家/地区代码、国旗展示）
- [x] SSH 端口
- [x] 认证方式（密码 / 密钥）
- [x] 分组（支持多选）
- [x] 标签（支持多选）

#### 2.2.2 VPS 费用管理
- [x] 多币种（USD、CNY、EUR、GBP、JPY 等）
- [x] 多付款周期（月付/季付/半年付/年付/两年付/三年付/自定义天数）
- [x] 费用金额
- [x] 带宽、流量、线路字段
- [x] 流量按 GB + 周期
- [x] 开始时间 / 到期时间
- [x] 自动续费开关（后台自动延长）
- [x] 续费记录（通过审计日志记录）
- [ ] 到期提醒通知

#### 2.2.3 添加 / 编辑 VPS
- [x] IP + 密码方式添加
- [x] IP + SSH 密钥方式添加
- [x] 自定义 SSH 端口
- [x] 添加时自动检测操作系统类型与架构
- [x] 添加成功后自动安装 Agent
- [x] “重装 Agent” 操作
- [x] SSH 凭证可选保存（加密存储）

#### 2.2.4 VPS 管理能力
- [x] VPS 列表展示（分页、搜索、状态筛选）
- [x] 编辑 VPS 信息（名称、标签、分组、费用）
- [x] 删除 VPS（仅删除记录）
- [ ] 删除 VPS 时自动卸载 Agent
- [ ] 批量操作（批量删除 / 批量执行等）

#### 2.2.5 UI 细节优化
- [ ] 分组管理/标签管理标题前展示图标（新增/列表）
  - 验收标准：
    - “新增分组/分组列表/新增标签/标签列表”标题前有一致风格图标

### 2.3 Agent 安装与通信
- [x] 自动检测 CPU 架构（amd64/arm64）
- [x] 自动下载并安装对应版本 Agent
- [x] 通过 SSH + SCP 上传 Agent 并完成安装
- [x] 注册 Agent 到控制面板（Token 认证）
- [x] 配置 Agent 自启动（systemd）
- [ ] 安装完成后关闭 SSH 密码登录（可选）

### 2.4 VPS DD 重装
- [x] 支持 DD 重装系统（reinstall.sh）
- [x] 可选系统版本（Debian/Ubuntu/CentOS/Rocky/Alpine）
- [x] 可设置 DD 后 root 密码
- [x] 可设置 DD 后 SSH 端口
- [x] 记录 DD 输出（stdout/stderr/exitCode）
- [x] 缺少 curl 时自动安装
- [x] DD 执行后自动重启
- [x] 支持强制重装（终止旧任务）
- [x] 重装完成以系统版本匹配为准（/etc/os-release）
- [x] 重装完成后自动重装 Agent

### 2.5 系统配置与配置管理

#### 2.5.1 配置模块（全局）
- [x] 网络配置（BBR+FQ、IPv6 禁用、IPv4 优先、自定义 sysctl）
- [x] 时区配置（timedatectl + NTP 开关）
- [x] DNS 配置（resolv.conf 写入 + chattr 锁定）
- [x] 配置保存（仅保存）
- [x] 手动同步（选择目标 VPS）
- [x] 同步结果返回（每台 VPS 成功/失败）
- [x] 仅通过 Agent 同步
- [x] 回滚（仅保留上一个版本）
- [ ] nftables 配置模块
- [ ] SSH 配置模块（端口、允许 Root 登录、允许密码登录）
- [ ] 用户配置模块

#### 2.5.2 配置查看与单机编辑
- [ ] 配置查看 Tab 支持单机编辑并保存（Network/SSH/DNS/Timezone）
  - 验收标准：
    - 在“配置查看”中点击服务器后，可编辑并保存
    - 保存成功后列表状态即时更新

### 2.13 缺陷修复（进行中）
- [ ] 修复时区配置页面白屏（detail 表单缺少 subDetail 处理函数）
  - 验收标准：
    - 打开时区配置页面不白屏
    - “配置查看”弹窗可正常打开并保存

### 2.6 软件管理
- [x] 软件定义（自定义安装/卸载脚本）
- [x] 安装 / 卸载到指定 VPS
- [x] 安装状态记录与历史
- [x] 服务状态查询与启停控制
- [x] 配置文件读取 / 更新
- [x] 全量刷新安装状态（checkCommand/versionCommand）
- [x] 基础软件一键安装（curl/wget/zip/unzip/tar/nftables 等）
- [ ] 预置软件库（如 Xray、Nginx、Realm 等）

### 2.7 监控与可视化

#### 2.7.1 基础信息
- [x] 操作系统版本
- [x] 内核版本
- [x] CPU 信息（型号、核心数、线程数）
- [x] 内存总量 / 可用量
- [x] 磁盘分区及使用情况
- [x] 网络接口及 IP 地址

#### 2.7.2 实时监控
- [x] CPU 使用率
- [x] 内存使用率
- [x] 磁盘 IO（读/写）
- [x] 网络流量（入站/出站）
- [x] 系统负载（1min, 5min, 15min）
- [x] 磁盘剩余空间
- [x] 监控曲线（缩放/悬浮值）
- [ ] 内存面积图
- [ ] IO / 流量单位统一为 MB/s 展示

#### 2.7.3 历史数据
- [x] 监控数据持久化存储
- [x] 清理过期数据（按天数）
- [ ] 数据保留策略可配置（UI）

#### 2.7.4 网络监控
- [x] 支持 TCP / ICMP 探测
- [x] 全局监控目标配置（系统设置）
- [x] 多目标下发到多台服务器
- [x] 最小周期限制（>=10s）
- [ ] 曲线平滑（EMA 等）

### 2.12 缺陷修复（进行中）
- [ ] 修复“服务器详情 > 实时监控”白屏问题（LineChart 需支持 extraSeries 入参，避免运行时引用未定义变量）
  - 验收标准：
    - 打开服务器详情页的“实时监控”标签页不再白屏
    - 系统负载图表可同时显示 1/5/15 分钟曲线
    - 其他图表渲染不受影响

### 2.8 仪表盘
- [x] 在线 / 离线 / 总数统计
- [x] 年度费用估算（按账单周期折算）
- [x] 全局与今日流量
- [x] 实时上下行速率
- [x] 列表展示 CPU / 内存 / 磁盘 / 流量 / 到期进度条
- [ ] 列表中 Logo 独立成“商家”列，Logo 高度固定 10px，宽度自适应

### 2.9 远程操作
- [x] 单台执行 Shell 命令
- [ ] 批量执行命令
- [ ] 命令执行历史记录
- [ ] 常用命令收藏
- [ ] 文件管理（上传 / 下载 / 编辑）
- [ ] Web SSH 终端

### 2.10 通知系统
- [x] 邮件通知配置
- [x] Telegram 通知配置
- [x] 通知测试
- [ ] 事件触发通知（到期、离线、阈值告警等）

### 2.11 系统管理
- [x] 审计日志
- [x] 系统设置（PUBLIC_BASE_URL、Agent 在线检查等）
- [x] 网络监控配置与下发
- [x] 清理过期数据接口
- [ ] 备份与恢复

## 3. 非功能需求

### 3.1 性能
- 支持 100+ 台 VPS 同时在线
- Agent 心跳默认 5 秒（可在配置中调整）
- Agent 离线阈值默认 90 秒
- 控制面板响应时间：< 500ms（内网/常规负载）

### 3.2 可靠性
- Agent 断线自动重连
- 服务启动时重置在线状态
- 监控数据支持按天清理

### 3.3 安全性
- Agent 与 Server 通信加密（WSS）
- Agent Token 认证
- 敏感信息 AES-256-GCM 加密存储
- 管理员密码 bcrypt 哈希存储
- 审计日志记录关键操作

## 4. 技术选型

| 组件 | 技术 | 说明 |
|------|------|------|
| 控制面板后端 | Node.js + Fastify + TypeScript | REST API + WebSocket |
| 控制面板前端 | React + TypeScript + Ant Design | Vite 构建 |
| Agent | Go | WebSocket 客户端 |
| 数据库 | SQLite (better-sqlite3) | Drizzle ORM |
| 通信协议 | WebSocket + JSON | Agent 与 Server 双向通信 |
| 初始 SSH 连接 | ssh2 | Agent 安装 |

## 5. 开发阶段规划

### Phase 1: 基础框架
- [x] 项目结构搭建
- [x] Agent 基础框架（心跳、重连、采集）
- [x] Server 基础框架（API、数据库）
- [x] VPS 添加与 Agent 安装流程

### Phase 2: 核心功能
- [x] 服务器信息收集
- [x] 命令执行
- [x] 配置管理（模块）
- [x] DD 重装

### Phase 3: 监控与告警
- [x] 实时监控数据采集
- [x] 监控面板
- [ ] 告警规则配置与通知

### Phase 4: 扩展功能
- [x] 软件管理
- [ ] Web 终端
- [ ] 文件管理

## 6. 待讨论事项

- [ ] 多用户权限模型是否需要
- [ ] 监控数据保留策略是否需要 UI 配置
- [ ] 是否需要支持 Windows VPS/Agent
- [ ] Web 终端实现方案（xterm.js + WebSocket）
- [ ] 批量操作与任务队列设计
